<!DOCTYPE html>
<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>

    <!-- <script src="/ytdl/scripts/easyInput.min.js" type="text/javascript"></script> -->
    <script src="/scripts/easyInput.min.js" type="text/javascript"></script>

    <!-- <link rel="stylesheet" href="/ytdl/styles/dist/easyInput.min.css"> -->
    <link rel="stylesheet" href="/styles/dist/easyInput.min.css">

    <!-- <link rel="stylesheet" href="/ytdl/styles/dist/style.css"> -->
    <link rel="stylesheet" href="/styles/dist/style.css">

</head>

<body>
    <div class="downloader-container">
        <div class="message-box" style="display: none;"></div>

        <input id="ytdl-input" placeholder="YouTube URL or Video ID...">
        <select id="ytdl-mediatype" class="ei">
            <option selected label="MP3 Only" value="audio-only">MP3 Only</option>
            <option label="Video Only" value="video-only">Video Only</option>
            <option label="Video + Audio (Low Quality But Quick)" value="video-and-audio-fast">Video + Audio (Low Quality But Quick)</option>
            <option label="Video + Audio (High Quality But Slow)" value="video-and-audio-slow">Video + Audio (High Quality But Slow)</option>
        </select>
        <div id="ytdl-go" class="button">Go</div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/ponyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/eligrey/Blob.js/Blob.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/StreamSaver.min.js"></script>
    <script>
        var wsClient = new WebSocket('ws://localhost:8081');
        var sessionUUID;
        var counter = 0;
        var downloadInProgress = false;

        wsClient.onmessage = (msg) => {
            try {
                var msgBody = JSON.parse(msg.data);
                if (msgBody.action == "update-uuid") {
                    sessionUUID = msgBody.uuid;
                }
                if (msgBody.action == "progress")
                {
                    if (msgBody.progress) {
                        $(".message-box").text(msgBody.progress);
                        $(".message-box").show();
                    }
                }
                if (msgBody.action == "uuid-test") console.log(msgBody.uuid);
            } catch (ex) {
                console.log("Error with message from server", ex)
            }
        };

        $("#ytdl-go").click(function () {
            if (downloadInProgress) return;

            var ytLink = $("#ytdl-input").val();
            var mediaType = $("#ytdl-mediatype").find(":selected").val();
           
           downloadInProgress = true;


            var downloadInterval = setInterval(function () {
                        if (!downloadInProgress) clearInterval(downloadInterval);
                        wsClient.send(stringify({ action: 'grab-progress' }))
                    }, 500);

            postData("/api", { youtubeLink: ytLink, fileType: mediaType, uuid: sessionUUID }).then(async res => {
                $(".message-box").hide();
                $(".message-box").removeClass("error");
                if (res.status == 500) {
                    downloadInProgress = false;
                    $(".message-box").addClass("error");
                    $(".message-box").text(await res.text());
                    $(".message-box").fadeIn(100);
                }

                if (res.status == 200) {

                    const fileStream = streamSaver.createWriteStream(res.headers.get("File-Name"));
                    const readableStream = res.body;
                    // more optimized
                    if (window.WritableStream && readableStream.pipeTo) {
                      return readableStream.pipeTo(fileStream)
                        .then(function () {
                            downloadInProgress = false;
                            console.log('done writing');
                        });
                    }

                    window.writer = fileStream.getWriter();
                    const reader = res.body.getReader();
                    const pump = () => reader.read()
                      .then(function (res) {
                          if (res.done) {
                              downloadInProgress = false;
                              console.log("Finished downloading.");
                              writer.close();
                          } else {
                            //if (counter % 10 == 0) wsClient.send("Still downloading.");
                            writer.write(res.value).then(pump);
                          }
                        });
                    pump();
                }
            });
        });

        async function postData(url = '', data = {}) {
            // Default options are marked with *
            const response = await fetch(url, {
                 method: 'POST', // *GET, POST, PUT, DELETE, etc.
                 mode: 'cors', // no-cors, *cors, same-origin
                 cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                 credentials: 'same-origin', // include, *same-origin, omit
                 headers: {
                   'Content-Type': 'application/json'
                   // 'Content-Type': 'application/x-www-form-urlencoded',
                 },
                 redirect: 'follow', // manual, *follow, error
                 referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                 body: JSON.stringify(data) // body data type must match "Content-Type" header
            });
            return response; // parses JSON response into native JavaScript objects
        }

        function stringify(thisObj) {
            return JSON.stringify(thisObj);
        }
    </script>
</body>